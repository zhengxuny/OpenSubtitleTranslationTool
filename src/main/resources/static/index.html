<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>视频字幕翻译工具</title>
    <meta charset="UTF-8">
    <style>
        .container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .status-area { margin-top: 20px; padding: 15px; border: 1px solid #eee; display: none; }
        .download-link { color: #28a745; text-decoration: none; margin-top: 10px; display: none; }
        /* 新增损坏提示样式 */
        .damage-prompt {
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #f5c6cb;
            background-color: #f8d7da;
            color: #721c24;
            display: none; /* 初始隐藏 */
        }
        .damage-prompt button {
            margin-right: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>上传视频生成翻译字幕</h1>

        <!-- 上传表单 -->
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" name="file" id="videoFile" accept="video/*" required>
            <button type="submit">上传视频</button>
        </form>

        <!-- 任务状态显示区域（初始隐藏） -->
        <div class="status-area" id="statusArea">
            <h3>任务进度跟踪</h3>
            <p>任务ID: <span id="taskId"></span></p>
            <p>当前状态: <span id="currentStatus">处理中...</span></p>
            <p>错误信息: <span id="errorMessage" style="color: red;"></span></p>

            <!-- 新增损坏提示区域 -->
            <div class="damage-prompt" id="damagePrompt">
                <p>⚠️ 检测到视频文件损坏，可能影响后续处理（如音轨提取失败）</p>
                <button id="continueBtn">继续处理（忽略损坏）</button>
                <button id="cancelBtn">取消任务</button>
            </div>

            <a class="download-link" id="downloadLink" href="#">下载翻译后的SRT文件</a>
        </div>
    </div>

    <!-- JavaScript逻辑 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function() {
            // 监听表单提交事件
            $('#uploadForm').submit(function(e) {
                e.preventDefault();
                const fileInput = $('#videoFile')[0];
                if (!fileInput.files.length) {
                    alert("请选择视频文件");
                    return;
                }

                // 构建FormData对象
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                // 发送上传请求到后端
                $.ajax({
                    url: '/api/video/upload',
                    type: 'POST',
                    data: formData,
                    processData: false, // 不处理数据（必须）
                    contentType: false, // 不设置Content-Type（必须）
                    success: function(response) {
                        if (!response.taskId) {
                            alert("上传失败: " + response.message);
                            return;
                        }
                        // 显示状态区域并开始轮询
                        $('#statusArea').show();
                        $('#taskId').text(response.taskId);
                        $('#currentStatus').text("已上传，等待处理...");
                        pollTaskStatus(response.taskId); // 启动状态轮询
                    },
                    error: function(xhr) {
                        alert("上传失败: " + xhr.responseJSON.message);
                    }
                });
            });

            // 轮询任务状态（每3秒查询一次）
            function pollTaskStatus(taskId) {
                const interval = setInterval(() => {
                    $.get(`/api/task/status/${taskId}`, function(task) {
                        if (!task) {
                            clearInterval(interval);
                            $('#currentStatus').text("任务不存在");
                            return;
                        }

                        // 更新状态文本
                        $('#currentStatus').text(task.status);
                        $('#errorMessage').text(task.errorMessage || "");

                        // 处理损坏状态
                        if (task.status === 'VIDEO_DAMAGED_AWAITING_USER_CHOICE') {
                            $('#damagePrompt').show(); // 显示损坏提示
                            clearInterval(interval); // 停止轮询等待用户操作

                            // 绑定继续处理按钮
                            $('#continueBtn').click(() => {
                                $.ajax({
                                    url: `/api/task/continue/${taskId}`,
                                    type: 'POST',
                                    success: () => {
                                        $('#damagePrompt').hide();
                                        $('#currentStatus').text("任务已重新启动处理...");
                                        pollTaskStatus(taskId); // 重新启动轮询
                                    },
                                    error: (xhr) => {
                                        alert("继续处理失败: " + xhr.responseJSON.message);
                                    }
                                });
                            });

                            // 绑定取消任务按钮
                            $('#cancelBtn').click(() => {
                                $.ajax({
                                    url: `/api/task/cancel/${taskId}`,
                                    type: 'POST',
                                    success: () => {
                                        $('#damagePrompt').hide();
                                        $('#currentStatus').text("任务已取消");
                                        clearInterval(interval);
                                    },
                                    error: (xhr) => {
                                        alert("取消任务失败: " + xhr.responseJSON.message);
                                    }
                                });
                            });
                        }

                        // 任务完成或失败时停止轮询
                        if (task.status === 'COMPLETED') {
                            $('#downloadLink').attr('href', `/api/task/download/srt/translated/${taskId}`);
                            $('#downloadLink').show();
                            clearInterval(interval);
                        } else if (['FAILED', 'CANCELLED'].includes(task.status)) {
                            clearInterval(interval);
                        }
                    });
                }, 3000); // 每3秒查询一次状态
            }
        });
    </script>
</body>
</html>
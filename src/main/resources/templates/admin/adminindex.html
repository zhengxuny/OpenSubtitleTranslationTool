<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <title>后台管理首页</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/admin-common.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .icon-circle {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .list-group-item {
      border: none;
      padding: 1rem 1.25rem;
    }
  </style>
</head>

<body>
  <!--
    /*
     *  @file: adminindex.html
     *  @功能：此页面是后台管理系统的首页，用于展示核心数据概览、最近动态等信息。
     *  @描述：
     *      - 使用Thymeleaf模板引擎来动态渲染数据。
     *      - 包含总用户数、总任务数、完成任务数、失败任务数等核心指标。
     *      - 展示最近的任务动态和注册用户，并提供链接到相应的管理页面。
     *      - 使用Chart.js库来展示每日新增用户和任务的趋势图。
     */
    -->

  <!-- 统一导航栏 -->
  <div th:replace="~{fragments/admin-navbar :: admin-navbar}"></div>

  <!-- 主容器 -->
  <div class="container admin-container mt-5">
    <!-- 核心数据概览 -->
    <!-- 修改为响应式布局行 -->
    <div class="row g-4 mb-5">
      <!-- 新增用户趋势图表卡片 -->
      <div class="col-md-6">
        <div class="card admin-card">
          <!-- 卡片头部，显示标题 -->
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">每日新增用户趋势</h5>
          </div>
          <!-- 卡片主体，包含图表 -->
          <div class="card-body">
            <!-- canvas元素用于渲染图表，id用于JavaScript中获取该元素 -->
            <canvas id="dailyUsersChart" height="100"></canvas>
          </div>
        </div>
      </div>

      <!-- 新增任务趋势图表卡片 -->
      <div class="col-md-6">
        <div class="card admin-card">
          <!-- 卡片头部，显示标题 -->
          <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">每日新增任务趋势</h5>
          </div>
          <!-- 卡片主体，包含图表 -->
          <div class="card-body">
            <!-- canvas元素用于渲染图表，id用于JavaScript中获取该元素 -->
            <canvas id="dailyTasksChart" height="100"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-5">
      <!-- 总用户数卡片 -->
      <div class="col-md-3 col-sm-6">
        <div class="card admin-card">
          <div class="card-body p-3">
            <div class="d-flex align-items-center">
              <!-- 图标 -->
              <div class="icon-circle bg-primary text-white me-3">
                <i class="fas fa-users"></i>
              </div>
              <div>
                <!-- 文本：总用户数 -->
                <h6 class="text-uppercase text-muted mb-1">总用户数</h6>
                <!-- 总用户数的值，使用Thymeleaf动态渲染 -->
                <h3 class="mb-0" th:text="${totalUsers}">128</h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 总任务数卡片 -->
      <div class="col-md-3 col-sm-6">
        <div class="card admin-card">
          <div class="card-body p-3">
            <div class="d-flex align-items-center">
              <!-- 图标 -->
              <div class="icon-circle bg-success text-white me-3">
                <i class="fas fa-tasks"></i>
              </div>
              <div>
                <!-- 文本：总任务数 -->
                <h6 class="text-uppercase text-muted mb-1">总任务数</h6>
                <!-- 总任务数的值，使用Thymeleaf动态渲染 -->
                <h3 class="mb-0" th:text="${totalTasks}">892</h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 完成任务卡片 -->
      <div class="col-md-3 col-sm-6">
        <div class="card admin-card">
          <div class="card-body p-3">
            <div class="d-flex align-items-center">
              <!-- 图标 -->
              <div class="icon-circle bg-info text-white me-3">
                <i class="fas fa-check-circle"></i>
              </div>
              <div>
                <!-- 文本：完成任务 -->
                <h6 class="text-uppercase text-muted mb-1">完成任务</h6>
                <!-- 完成任务的值，使用Thymeleaf动态渲染 -->
                <h3 class="mb-0" th:text="${completedTasks}">685</h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 失败任务卡片 -->
      <div class="col-md-3 col-sm-6">
        <div class="card admin-card">
          <div class="card-body p-3">
            <div class="d-flex align-items-center">
              <!-- 图标 -->
              <div class="icon-circle bg-danger text-white me-3">
                <i class="fas fa-exclamation-circle"></i>
              </div>
              <div>
                <!-- 文本：失败任务 -->
                <h6 class="text-uppercase text-muted mb-1">失败任务</h6>
                <!-- 失败任务的值，使用Thymeleaf动态渲染 -->
                <h3 class="mb-0" th:text="${failedTasks}">42</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 最近动态 -->
    <div class="row g-4">
      <!-- 最近任务 -->
      <div class="col-lg-6">
        <div class="card admin-card">
          <!-- 卡片头部，显示标题和“查看全部”链接 -->
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">最近任务动态</h5>
            <!-- 链接到任务管理页面 -->
            <a href="/admin/tasks" class="text-white text-decoration-none">查看全部 ></a>
          </div>
          <!-- 卡片主体，显示最近的任务列表 -->
          <div class="card-body p-3">
            <ul class="list-group list-group-flush">
              <!-- 循环遍历recentTasks列表，动态生成任务列表项 -->
              <li class="list-group-item d-flex justify-content-between align-items-center"
                th:each="task : ${recentTasks}">
                <div>
                  <!-- 任务的原始视频文件名 -->
                  <span th:text="${task.originalVideoFilename}" class="fw-medium"></span><br>
                  <!-- 任务创建时间，格式化为HH:mm -->
                  <small class="text-muted" th:text="${#temporals.format(task.createdAt, 'HH:mm')}">10:30</small>
                </div>
                <!-- 任务状态的徽章，根据状态显示不同的颜色 -->
                <span class="badge"
                  th:classappend="${task.status.name() == 'COMPLETED' ? 'bg-success' :
                                                      (task.status.name() == 'FAILED' ? 'bg-danger' : 'bg-secondary')}"
                  th:text="${task.status.displayName}">
                </span>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- 最近用户 -->
      <div class="col-lg-6">
        <div class="card admin-card">
          <!-- 卡片头部，显示标题和“查看全部”链接 -->
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">最近注册用户</h5>
            <!-- 链接到用户管理页面 -->
            <a href="/admin/users" class="text-white text-decoration-none">查看全部 ></a>
          </div>
          <!-- 卡片主体，显示最近注册的用户列表 -->
          <div class="card-body p-3">
            <ul class="list-group list-group-flush">
              <!-- 循环遍历recentUsers列表，动态生成用户列表项 -->
              <li class="list-group-item d-flex justify-content-between align-items-center"
                th:each="user : ${recentUsers}">
                <div>
                  <!-- 用户名 -->
                  <span th:text="${user.username}" class="fw-medium"></span><br>
                  <!-- 用户注册时间，格式化为HH:mm -->
                  <small class="text-muted" th:text="${#temporals.format(user.createdAt, 'HH:mm')}">09:15</small>
                </div>
                <!-- 新注册用户的徽章 -->
                <span class="badge bg-info">新注册</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 引入Bootstrap的JavaScript库 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- 使用Thymeleaf的inline script，可以直接在JavaScript中使用Thymeleaf变量 -->
  <script th:inline="javascript">
    /**
     * @function initDailyUsersChart
     * @description 初始化每日新增用户图表。
     *              从Thymeleaf模板引擎获取每日新增用户数据，并使用Chart.js库渲染成折线图。
     *              如果数据为空，则在图表区域显示“暂无数据”。
     */
    function initDailyUsersChart() {
      // 从Thymeleaf模板引擎获取每日新增用户数据
      const dailyNewUsers = /*[[${dailyNewUsers}]]*/ [];

      // 从每日新增用户数据中提取日期，并格式化为MM/DD的格式
      const labels = dailyNewUsers.map(item => {
        // 将日期字符串转换为Date对象，然后格式化为toISOString字符串，截取需要的片段，并替换分隔符
        return new Date(item.date).toISOString().slice(5, 10).replace('-', '/');
      });
      // 从每日新增用户数据中提取用户数量
      const data = dailyNewUsers.map(item => item.count);

      // 如果日期或数据为空，则在图表区域显示“暂无数据”
      if (labels.length === 0 || data.length === 0) {
        // 获取canvas元素的2D渲染上下文
        const ctx = document.getElementById('dailyUsersChart').getContext('2d');
        // 设置字体样式
        ctx.font = '16px Arial';
        // 设置填充颜色
        ctx.fillStyle = '#999';
        // 设置文本对齐方式
        ctx.textAlign = 'center';
        // 在canvas中心位置绘制文本
        ctx.fillText('暂无数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
      }

      // 获取canvas元素的2D渲染上下文
      const ctx = document.getElementById('dailyUsersChart').getContext('2d');
      // 创建一个新的Chart对象，并配置图表类型、数据和选项
      new Chart(ctx, {
        // 图表类型为折线图
        type: 'line',
        // 图表数据
        data: {
          // X轴标签
          labels: labels,
          // 数据集
          datasets: [{
            // 数据集标签
            label: '新增用户数',
            // 数据
            data: data,
            // 背景颜色
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            // 边框颜色
            borderColor: 'rgba(54, 162, 235, 1)',
            // 边框宽度
            borderWidth: 2,
            // 曲线张力，用于控制曲线的弯曲程度
            tension: 0.4,
            // 是否填充曲线下方区域
            fill: true
          }]
        },
        // 图表选项
        options: {
          // 缩放选项
          scales: {
            // Y轴选项
            y: {
              // Y轴从0开始
              beginAtZero: true,
              // 刻度选项
              ticks: {
                // 步长，用于控制刻度的间隔
                stepSize: 1,
                /**
                 * @function callback
                 * @description 回调函数，用于格式化Y轴刻度标签。
                 * @param {number} value 刻度值
                 * @returns {string|number} 如果刻度值为整数，则返回该值；否则返回空字符串。
                 */
                callback: function (value) {
                  // 如果刻度值为整数，则返回该值；否则返回空字符串
                  if (value % 1 === 0) {
                    return value;
                  }
                }
              }
            }
          }
        }
      });
    }

    /**
     * @function initDailyTasksChart
     * @description 初始化每日新增任务图表。
     *              从Thymeleaf模板引擎获取每日新增任务数据，并使用Chart.js库渲染成折线图。
     *              如果数据为空，则在图表区域显示“暂无数据”。
     */
    function initDailyTasksChart() {
      // 从Thymeleaf模板引擎获取每日新增任务数据
      const dailyNewTasks = /*[[${dailyNewTasks}]]*/ [];

      // 从每日新增任务数据中提取日期，并格式化为MM/DD的格式
      const taskLabels = dailyNewTasks.map(item =>
        // 将日期字符串转换为Date对象，然后格式化为toISOString字符串，截取需要的片段，并替换分隔符
        new Date(item.date).toISOString().slice(5, 10).replace('-', '/')
      );
      // 从每日新增任务数据中提取任务数量
      const taskData = dailyNewTasks.map(item => item.count);

      // 获取canvas元素的2D渲染上下文
      const taskCtx = document.getElementById('dailyTasksChart').getContext('2d');

      // 如果日期或数据为空，则在图表区域显示“暂无数据”
      if (taskLabels.length === 0 || taskData.length === 0) {
        // 设置字体样式
        taskCtx.font = '16px Arial';
        // 设置填充颜色
        taskCtx.fillStyle = '#999';
        // 设置文本对齐方式
        taskCtx.textAlign = 'center';
        // 在canvas中心位置绘制文本
        taskCtx.fillText('暂无数据', taskCtx.canvas.width / 2, taskCtx.canvas.height / 2);
        return;
      }

      // 创建一个新的Chart对象，并配置图表类型、数据和选项
      new Chart(taskCtx, {
        // 图表类型为折线图
        type: 'line',
        // 图表数据
        data: {
          // X轴标签
          labels: taskLabels,
          // 数据集
          datasets: [{
            // 数据集标签
            label: '新增任务数',
            // 数据
            data: taskData,
            // 背景颜色，青绿色调
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            // 边框颜色，青绿色调
            borderColor: 'rgba(75, 192, 192, 1)',
            // 边框宽度
            borderWidth: 2,
            // 曲线张力，用于控制曲线的弯曲程度
            tension: 0.4,
            // 是否填充曲线下方区域
            fill: true
          }]
        },
        // 图表选项
        options: {
          // 缩放选项
          scales: {
            // Y轴选项
            y: {
              // Y轴从0开始
              beginAtZero: true,
              // 刻度选项
              ticks: {
                // 步长，用于控制刻度的间隔
                stepSize: 1,
                /**
                 * @function callback
                 * @description 回调函数，用于格式化Y轴刻度标签。
                 * @param {number} value 刻度值
                 * @returns {string|number} 如果刻度值为整数，则返回该值；否则返回空字符串。
                 */
                callback: function (value) {
                  // 如果刻度值为整数，则返回该值；否则返回空字符串
                  return value % 1 === 0 ? value : '';
                }
              }
            }
          }
        }
      });
    }

    /**
     * @function window.onload
     * @description 页面加载完成时执行的函数。
     *              用于初始化页面上的图表。
     * @fires initDailyUsersChart
     * @fires initDailyTasksChart
     */
    // 页面加载时初始化两个图表
    window.onload = function () {
      initDailyUsersChart(); // 原有用户图表初始化函数（需要提取为独立函数）
      initDailyTasksChart(); // 新增任务图表初始化
    };
  </script>

</body>

</html>
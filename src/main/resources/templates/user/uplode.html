<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>视频字幕翻译工具 - 上传</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/static/css/global.css}">
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-4">
    <h1 class="mb-4"></h1>

    <div class="card shadow-sm">
        <div class="card-body p-4">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="videoFile" class="form-label">选择视频文件:</label>
                    <input type="file" name="file" id="videoFile" class="form-control" accept="video/*" required>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="burnSubtitles">
                    <label class="form-check-label" for="burnSubtitles">
                        同时压制字幕到视频
                    </label>
                </div>
                <button type="submit" class="btn btn-success w-100">
                    <i class="fas fa-cloud-upload-alt"></i> 开始上传
                </button>
            </form>
            <div class="text-center mt-3">
                <a href="/topup">余额不足？立即充值</a>
            </div>
        </div>
    </div>

    <!-- 任务状态显示区域 -->
    <div class="mt-4" id="statusArea" style="display: none;">
        <div class="card">
            <div class="card-header">任务状态</div>
            <div class="card-body">
                <p><strong>任务ID:</strong> <span id="taskId"></span></p>
                <p><strong>当前状态:</strong> <span id="currentStatus" class="fw-bold">处理中...</span></p>

                <div id="errorArea" class="alert alert-danger mt-2" style="display: none;">
                    <strong>错误信息:</strong> <span id="errorMessage"></span>
                </div>

                <!-- 损坏提示区域 -->
                <div class="alert alert-warning mt-3" id="damagePrompt" style="display: none;">
                    <p class="mb-2">⚠️ 检测到视频文件损坏，可能影响后续处理（如音轨提取失败）</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-warning" id="continueBtn">继续处理 (忽略)</button>
                        <button class="btn btn-sm btn-danger" id="cancelBtn">取消任务</button>
                    </div>
                </div>

                <!-- 下载链接 -->
                <div id="downloadLinksContainer" class="mt-3">
                    <a class="btn btn-primary btn-sm me-2" id="downloadLink" href="#" style="display: none;">
                        <i class="fas fa-file-alt"></i> 下载翻译后的SRT文件
                    </a>
                    <a class="btn btn-primary btn-sm" id="videoDownloadLink" href="#" style="display: none;">
                        <i class="fas fa-video"></i> 下载压制后的视频
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        // Helper function to show BS alert
        function showAlert(type, message, areaId = 'uploadFormMessage') { // a generic message area could be added to the form
            const messageArea = $('#' + areaId);
            if (messageArea.length === 0 && areaId === 'uploadFormMessage') { // Create if doesn't exist for form
                $('#uploadForm').prepend(`<div id="${areaId}" class="mb-3"></div>`);
            }
            $('#' + areaId).html(`<div class="alert alert-${type}" role="alert">${message}</div>`).show();
        }


        $('#uploadForm').submit(function(e) {
            e.preventDefault();
            $('#uploadFormMessage').remove(); // Clear previous form message
            const fileInput = $('#videoFile')[0];
            if (!fileInput.files.length) {
                showAlert('warning', '请选择视频文件');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('burnSubtitles', document.getElementById('burnSubtitles').checked);

            // Disable button during upload
            $(this).find('button[type="submit"]').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 上传中...');


            $.ajax({
                url: '/api/video/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (!response.taskId) {
                        showAlert('danger', "上传失败: " + (response.message || "未知错误"));
                        return;
                    }
                    $('#statusArea').show();
                    $('#taskId').text(response.taskId);
                    $('#currentStatus').text("已上传，等待处理...").removeClass('text-success text-danger').addClass('text-info');
                    $('#errorArea').hide();
                    $('#damagePrompt').hide();
                    $('#downloadLink, #videoDownloadLink').hide();
                    pollTaskStatus(response.taskId);
                },
                error: function(xhr) {
                    showAlert('danger', "上传失败: " + (xhr.responseJSON ? xhr.responseJSON.message : "服务错误"));
                },
                complete: function() {
                    $('#uploadForm').find('button[type="submit"]').prop('disabled', false).html('<i class="fas fa-cloud-upload-alt"></i> 开始上传');
                }
            });
        });

        function pollTaskStatus(taskId) {
            const interval = setInterval(() => {
                $.get(`/api/task/status/${taskId}`, function(task) {
                    if (!task) {
                        clearInterval(interval);
                        $('#currentStatus').text("任务不存在").removeClass('text-info text-success').addClass('text-danger');
                        return;
                    }

                    $('#currentStatus').text(task.status.displayName || task.status); // Assuming status might be an enum or object
                    // Reset color classes and apply new one
                    $('#currentStatus').removeClass('text-info text-success text-danger text-warning');
                    if (task.status === 'COMPLETED') $('#currentStatus').addClass('text-success');
                    else if (task.status === 'FAILED' || task.status === 'CANCELLED') $('#currentStatus').addClass('text-danger');
                    else if (task.status === 'VIDEO_DAMAGED_AWAITING_USER_CHOICE') $('#currentStatus').addClass('text-warning');
                    else $('#currentStatus').addClass('text-info');


                    if (task.errorMessage) {
                        $('#errorArea').show();
                        $('#errorMessage').text(task.errorMessage);
                    } else {
                        $('#errorArea').hide();
                    }

                    if (task.status === 'VIDEO_DAMAGED_AWAITING_USER_CHOICE') {
                        $('#damagePrompt').show();
                        clearInterval(interval); // Stop polling until user acts

                        $('#continueBtn').off('click').on('click', () => { // Use .off().on() to prevent multiple bindings
                            $('#continueBtn, #cancelBtn').prop('disabled', true);
                            $.post(`/api/task/continue/${taskId}`)
                                .done(() => {
                                    $('#damagePrompt').hide();
                                    $('#currentStatus').text("任务已重新启动处理...").removeClass('text-warning').addClass('text-info');
                                    pollTaskStatus(taskId);
                                })
                                .fail(xhr => alert("继续处理失败: " + (xhr.responseJSON ? xhr.responseJSON.message : "服务错误")))
                                .always(() => $('#continueBtn, #cancelBtn').prop('disabled', false));
                        });

                        $('#cancelBtn').off('click').on('click', () => {
                            $('#continueBtn, #cancelBtn').prop('disabled', true);
                            $.post(`/api/task/cancel/${taskId}`)
                                .done(() => {
                                    $('#damagePrompt').hide();
                                    $('#currentStatus').text("任务已取消").removeClass('text-warning').addClass('text-danger');
                                    clearInterval(interval);
                                })
                                .fail(xhr => alert("取消任务失败: " + (xhr.responseJSON ? xhr.responseJSON.message : "服务错误")))
                                .always(() => $('#continueBtn, #cancelBtn').prop('disabled', false));
                        });
                    } else {
                        $('#damagePrompt').hide(); // Hide if status changes from damaged
                    }

                    if (task.status === 'COMPLETED') {
                        $('#downloadLink').attr('href', `/api/task/download/srt/translated/${taskId}`).show();
                        if (task.burnSubtitles && task.subtitledVideoFilePath) {
                            $('#videoDownloadLink').attr('href', `/api/task/download/video/subtitled/${taskId}`).show();
                        }
                        clearInterval(interval);
                    } else if (['FAILED', 'CANCELLED'].includes(task.status)) {
                        clearInterval(interval);
                    }
                }).fail(function() {
                    // Handle polling error (e.g., network issue, server down)
                    console.error("Polling failed for task " + taskId);
                    // Optionally, inform the user or stop polling after several failures
                });
            }, 3000);
        }
    });
</script>
</body>
</html>